# One Piece Quiz App - AI Developer Instructions

## Project Overview
React Native/Expo quiz game app with One Piece anime theme. Features progressive saga unlocking, persistent storage, and both guided and free-play modes.

**Generated by**: AI based on user specifications
**Current Status**: CRITICAL BUGS - App not functional for production
**Target Platforms**: Web + Mobile (iOS/Android)
**Priority**: Fix core gameplay logic before API integration

## Architecture Patterns

### State Management
- **Global state**: `GameContext` using `useReducer` pattern with typed actions
- **Local storage**: `AsyncStorage` via `StorageService` class for saga progress and game stats
- **State structure**: Sagas progress, game stats, and current game session are separate concerns

### Navigation & Routing
- **Expo Router v5** with file-based routing and typed routes enabled
- **Structure**: `app/_layout.tsx` (root) → `app/(tabs)/_layout.tsx` (tab navigation) → screen files
- **Modal screens**: `quiz.tsx`, `results.tsx`, `free-mode.tsx` are stack screens outside tabs
- **Parameters**: Use `useLocalSearchParams<{}>()` with explicit typing for screen params

### Data Architecture
- **Question database**: Currently static array in `services/questionsApi.ts` with Spanish content (MOCK DATA)
- **Real API**: `https://trivia-one-piece-api.onrender.com` - needs integration
  - GET `/questions?amount=10&saga=east-blue&difficulty=easy`
  - POST `/check_answer` (body: `{question_id: number, answer: string, username: string}`)
- **Progressive unlocking**: Sagas unlock sequentially based on completion (see `unlockNextSaga` in GameContext)
- **Scoring system**: Track streak, total score, time spent per question (30s timer)
- **CORS/Fallback**: API has CORS configured but may fail in browser - implement local fallback

## Key Development Patterns

### Component Structure
```tsx
// Standard component pattern with proper typing
interface ComponentProps {
  // Always type props explicitly
}

export function Component({ prop }: ComponentProps) {
  // Use absolute imports with @ alias
  // Follow established naming: PascalCase for components
}
```

### Storage Integration
```tsx
// Always use StorageService class methods, never AsyncStorage directly
import { StorageService } from '@/services/storage';

// Update patterns maintain immutability
const updatedSagas = sagas.map(saga => 
  saga.id === sagaId ? { ...saga, ...updates } : saga
);
```

### Game Flow Integration
- Start game: Load questions → `startGame()` → Update `currentGame` state
- During quiz: `answerQuestion()` updates score/streak, advances question index
- End game: `endGame()` clears state, `updateSagaProgress()` persists results

## UI/Styling Conventions
- **Colors**: Use `Colors` constant from `@/constants/colors`, pirate theme (navy/gold/red)
- **Fonts**: PirataOne for headers, Inter for body text (loaded in root layout)
- **Components**: Reusable UI in `components/ui/` (Button, Card, ProgressBar, LoadingSpinner)
- **Gradients**: Use `gradients` object for consistent theming

## Development Workflow
```bash
# Development server
npm run dev

# Web export
npm run build:web

# Linting
npm run lint
```

## Current Development Priorities
1. **CRITICAL: Fix first question bug** - first question always marked incorrect regardless of answer
2. **Fix question scoring logic** - answers showing 2/3 when should be 3/3 correct
3. **Verify answer validation** - case-insensitive comparison may not be working properly
4. **Navigation error handling** - ensure proper routing between quiz and results
5. **API Integration** - replace mock data with real API calls (AFTER core fixes)

## Known Critical Issues
- **First Question Bug**: First question always shows as incorrect (0% → should be 100%)
- **Scoring Mismatch**: 3 correct answers show as 2/3 instead of 3/3
- **Answer Validation**: trim().toLowerCase() comparison may have edge cases
- **State Management**: Potential race conditions in GameContext reducer
- **Mock Data**: Current `questionsApi.ts` contains static data - needs API integration

## Critical Debugging Information
Based on technical analysis, current issues:

### First Question Always Wrong Bug
- **Symptom**: First question always marked incorrect (0/1 = 0%)
- **Pattern**: Subsequent questions work correctly (showing 2/3 when answering 3 correctly)
- **Location**: Likely in `GameContext.tsx` reducer or `quiz.tsx` answer validation
- **Root Cause**: State initialization or index offset problem

### Answer Validation Logic
```tsx
// Current implementation may have issues
const isCorrect = answer.trim().toLowerCase() === currentQuestion.correct_answer.trim().toLowerCase();
```

### State Flow Issues
- `answerQuestion()` in GameContext may not handle first question correctly
- `currentQuestionIndex` initialization or increment timing
- Race conditions between timer, answer submission, and state updates
- **Font loading**: Must complete before hiding splash screen in `_layout.tsx`
- **Context wrapping**: `GameProvider` wraps entire app, provides game state globally  
- **Storage initialization**: First-time users get default `SAGAS` data structure
- **Timer system**: 30-second per-question countdown with `useEffect` cleanup
- **Route params**: Quiz screen expects `mode`, `sagaId`, `amount`, `difficulty` parameters

## Spanish Language Context
All question content, UI text, and saga names are in Spanish. When adding content, maintain this language consistency. Saga names: "East Blue", "Alabasta", "Skypea" with corresponding emojis defined in `constants/sagas.ts`.

## Framework-Specific Notes
- **Expo Router**: File-based routing with `(tabs)` group syntax for tab navigation
- **TypeScript strict mode**: All types must be explicit, use interfaces from `types/game.ts`
- **Cross-platform**: Targets web, iOS, Android - avoid platform-specific code without checks
- **Hook integration**: Custom `useFrameworkReady()` for external framework compatibility

## API Integration Strategy
```typescript
// Future API service pattern
const fetchQuestions = async (saga: string, amount: number, difficulty: string) => {
  try {
    const response = await fetch(
      `https://trivia-one-piece-api.onrender.com/questions?amount=${amount}&saga=${saga}&difficulty=${difficulty}`
    );
    return await response.json();
  } catch (error) {
    // Fallback to local mock data
    return getLocalQuestions(saga, difficulty, amount);
  }
};

// Answer checking with API
const checkAnswer = async (questionId: number, answer: string, username: string) => {
  try {
    return await fetch('https://trivia-one-piece-api.onrender.com/check_answer', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ question_id: questionId, answer, username })
    });
  } catch (error) {
    // Local validation fallback
    return validateAnswerLocally(questionId, answer);
  }
};
```
